{% extends "base/base.html" %}
{% load static %}

{% block content %}
<style>
    label {
    display: flex;
    align-items: center; /* Optional - align content vertically */
}
</style>

<div>
    <form method="post" id="workOrderViewForm">
        {% csrf_token %}
        <div class="row">
                <div class="col card">
                    <label>
                        <div id="is_rush_d" class="col">{% if not workOrder.is_rush %}No rush{% else %}Rush{% endif %}</div>
                        <div class="col">{{workOrderForm.is_rush}}</div>
                        

                    </label>
                </div>
                <div class="col-2 card">
                    <lable>
                        <div id="quote_required_d">{% if not workOrder.quote_required %}No quote needed{% else %}Quote Is Required{% endif %}</div>
                        {{workOrderForm.quote_required}}
                    </lable>
                    
                </div>
                <div class="col-md-6 card" >
                        <div id="specialInstructions_d">Instructions - {{workOrder.specialInstructions}}</div>
                        <input type="text" id="specialInstructions" name="specialInstructions">
                </div>
                <div class="col card">
                    <div id="return_by_d">{{initial_return_by}}</div>
                    {{workOrderForm.return_by}}
                </div>
        </div>
    </form>

    

    <div class="row" style="margin: 15px 0px 0px 15px; padding-bottom: 10px;">
        <div class="col-6">
            <div class="row">
                <div class="col-5">
                    <a href="{% url 'invoice:pdfTracker' workOrder_id %}" target="_blank" class="btn btn-primary">Preview Blue Card PDF</a>
                    
                </div>
                <div class="col-6">
                    <a href="{% url 'invoice:pdfCustomerTracking' workOrder_id %}" target="_blank" class="btn btn-primary">Preview Take Back Sheet PDF</a>
                </div>
            </div>
        </div>    
        <div class="col-6">
            <div class="row">
                <div class="col-8">
                    <a href="{% url 'invoice:customWorkOrderItem' workOrder_id %}">
                        <button class="btn btn-primary">Add Item Not Listed</button>
                    </a>

                </div>
                <div class="col-4">
                    
                </div>
            </div>
        </div>
    </div>



    <div class="row" style="min-height: 600px;" id="test">
        <div class="col-md-5 card card-body" >
            <table class="table" id="item-table">
                <thead>
                    <tr>
                        <th>Number</th>
                        <th>Product Name</th>
                        <th>Quantity</th>
                        <th>Description</th>
                        <th>Edit</th>
                        <th>Delete</th>
                    </tr>
                </thead>
                <tbody >
                    {% for i in workOrderItems %}
                    <tr>
                        <td>{{ i.number }}</td>
                        {% if i.product.name == "Other" %}
                            <td>{{ i.custom_product_name }}</td>
                        {% else %}
                            <td>{{ i.product.name }}</td>
                        {% endif %}
                        <td>{{ i.quantity }}</td>
                        {% if i.product.name == "Other" %}
                            <td>{{ i.custom_product_description }}</td>
                        {% else %}
                            <td>{{ i.description }}</td>
                        {% endif %}
                        <td>
                            <a href="#">edit</a>
                        </td>
                        <td>
                            <a href="#" class="delete-link" data-itemid="{{ i.id }}">delete</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="col-md-7 ">
            
            <div>
            
                <div class="card card-body" style="margin-bottom: 15px;">
                    <form method="get">
                        {{myFilter.form.as_table}}
                        <button class="btn btn-primary">Search</button>
                        <a class="btn btn-warning" href="{% url 'invoice:addItemsWorkOrder' workOrder_id %}">Reset</a>
                    </form>
                </div>
                <div class="pagination text-center" >
                    <span class="step-links">
                        {% if products.has_next %}
                            <a href="?page={{ products.paginator.num_pages }}">last</a>
                            <a href="?page={{ products.next_page_number }}">next</a>
                        {% endif %}
                    
                        <span class="current-page">
                            Page {{ products.number }} of {{ products.paginator.num_pages }}.
                        </span>
                    
                        {% if products.has_previous %}
                            <a href="?page={{ products.previous_page_number }}">previous</a>
                            <a href="?page=1">first</a>
                        {% endif %}
                    </span>
                </div>
                <div class="card card-body" style="min-height: 500px;">
                    <form method="post" id="workOrderForm">
                        {% csrf_token %}
                        <table class="table">
                            <tr>
                                <th>Name</th>
                                <th>Product Type</th>
                                <th>Quantity</th>
                                <th>Manufacter #</th>
                                <th>Description</th>
                                <th>Add Item</th>
                            </tr>
                            {% for i in products %}
                                <tr>
                                    <td style="text-wrap: nowrap;">{{ i.name }}</td>
                                    <td>{{ i.product_type }}</td>
                                    <td>
                                        <input style="width: 50px;" type="number" name="quantity" id="quantity" value="" min="1">
                                    </td>
                                    <td>
                                        <input style="width: 100px;" type="text" name="mfgnum" id="mfgnum" maxlength="50" value="">
                                    </td>
                                    <td>
                                        
                                        <textarea style="height: 75px; word-wrap: break-word;" name="description" id="description" maxlength="85"></textarea>
                                        <input type="hidden" name="product" value="{{ i.pk }}">
                                        <input type="hidden" name="workOrder" value="{{ workOrder_id }}">
                                    </td>
                                    <td>
                                        <button type="button" class="submit-button">Add Item</button>
                                    </td>
                                </tr>
                            {% endfor %}
                        </table>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.js" ></script>
<script>
let workOrder_id = '{{ workOrder_id }}';
let site_url = '{{ site_url }}';
let apiUrl = "{% url 'invoice:itemWorkOrderAPI' workOrder_id %}";
let crsfToken = '{% csrf_token %}';

</script>

<script src="{% static 'js/addItemsWorkOrder.js' %}"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>


<!-- Bootstrap Datepicker CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">

<!-- Bootstrap Datepicker JavaScript -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>


<script>
    $(document).ready(function() {
        $('.datepicker').datepicker({
            format: 'yyyy-mm-dd',  // Adjust the date format as needed
            autoclose: true
        });
    });
</script>

<script>
    $(document).ready(function() {
        // Get the CSRF token from the template
        var csrfToken = $('input[name=csrfmiddlewaretoken]').val();
        var apiUrl = 'http://127.0.0.1:8000/workOrder/api/deleteWorkOrderItem/';
        var workOrder_id = "{{workOrder_id}}"

        // Attach a click event listener to the "delete" links
        $('.delete-link').on('click', function(e) {
            e.preventDefault(); // Prevent the default link behavior
            const id = $(this).data('itemid');
            deleteData(apiUrl, csrfToken, workOrder_id, id);
        });

        function deleteData(apiEndpoint, csrfToken, workOrder_id, id) {
            // Set up the CSRF token in the request headers
            var headers = {
                'X-CSRFToken': csrfToken
            };

            $.ajax({
                type: 'DELETE',
                url: apiEndpoint,
                data: JSON.stringify({ workOrder_id: workOrder_id, id: id }),
                contentType: 'application/json',
                headers: headers,
                success: function(data) {
                    console.log("test");
                    location.reload(); // Reload the page
                },
                error: function(error) {
                    console.error(error);
                }
            });
        }
    });
    </script>




<script>
    $(document).ready(function() {
        // Get the CSRF token from the template
        var csrfToken = $('input[name=csrfmiddlewaretoken]').val();
        var apiUrl = 'http://127.0.0.1:8000/workOrder/api/workOrderEnrichment/';
        var workOrder_id = "{{workOrder_id}}"
    
        // Attach a change event listener to the "is_rush" checkbox
        $('input[name="is_rush"]').on('change', function() {
            var isRush = $(this).is(':checked');
            var type = "is_rush";
    
            updateData(apiUrl, csrfToken,workOrder_id,type, isRush);
        });
        $('input[name="quote_required"]').on('change', function() {
            var quote_required = $(this).is(':checked');
            var type = "quote_required";
    
            updateData(apiUrl, csrfToken,workOrder_id,type, quote_required);
        });
        
        $('#specialInstructions').on('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault(); // Prevent the default Enter key behavior
                var specialInstructionsValue = $(this).val(); // Get the value from the text box

                var type = "specialInstructions";

                updateData(apiUrl, csrfToken, workOrder_id,type, specialInstructionsValue);
            }
        });

        $('input[name="return_by"]').on('change', function() {
            var return_by = $(this).val();
            var type = "return_by";
            console.log(return_by);

            updateData(apiUrl, csrfToken, workOrder_id, type, return_by);
        });
    
        function updateData(apiEndpoint, csrfToken,workOrder_id,type, value) {
            // Set up the CSRF token in the request headers
            var headers = {
                'X-CSRFToken': csrfToken
            };
    
            $.ajax({
                type: 'POST',
                url: apiEndpoint,
                data: JSON.stringify({ workOrder_id: workOrder_id, type: type, value: value }),
                contentType: 'application/json',
                headers: headers,
                success: function(data) {
                    console.log(data);
                    
                    // Update the specific content within the container
                    if (type === 'specialInstructions') {
                        $( "#specialInstructions_d" ).load(window.location.href + " #specialInstructions_d" );
                        
                    } else if (type === 'is_rush') {
                        $( "#is_rush_d" ).load(window.location.href + " #is_rush_d" );
                    } else if (type === 'return_by') {
                        $( "#return_by_d" ).load(window.location.href + " #return_by_d" );
                    } else if (type === 'quote_required') {
                        $( "#quote_required_d" ).load(window.location.href + " #quote_required_d" );
                    } else {
                        // Handle other content updates
                    }
                },
                error: function(error) {
                    console.error(error);
                }
            });
        }
    });
    </script>

{% endblock content %}